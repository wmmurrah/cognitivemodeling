%% Correlation Coefficient

clear;

sampler = 1; % Choose 0=WinBUGS, 1=JAGS

%% Data
% Choose dataset
dataset = 3;
switch dataset
    case 1, x = [ .8,102; 1,98; .5,100; 0.9,105; .7,103;... 
               0.4,110; 1.2,99; 1.4,87; 0.6,113; 1.1,89; 1.3,93];
    case 2, x = [ .8,102; 1,98; .5,100; 0.9,105; .7,103;... 
               0.4,110; 1.2,99; 1.4,87; 0.6,113; 1.1,89; 1.3,93];
            x = [x;x];
    case 3, % missing values Daniel Stehr
        x=[203.004926	459.5455703
208.5059865	443.5056117
216.0289331	447.5501405
204.0612668	425.5188042
217.0092164	470.5155169
217.0288376	467.0769607
207.5024096	435.0114941
210.5154248	469.026118
200.0249979	419.5023474
222.0202693	469.0133104
177.0112991	404.0012379
207.0012077	429.0029138
188.0596384	437.1166975
218.5696995	450.0467484
213.5011682	466.0140037
202.0160582	446.0229593
181.0069059	411.5121772
205.0012255	461.0043389
226.0276531	478.104089
221.0193064	474.0195141
217.0057764	475.0105665
209.5120016	471.0323893
207.5011962	469.0198422
198.0315191	431.5028714
197.516439	450.0535676
200.5012376	450.0022573
214.5209781	456.5054812
205.5	457.5136652
193.5	400
202.0061698	468.0240377
213.51869	448.5762903
223.5044642	453.5143765
201.5893108	470.0771611
212	470.1183118
216.5011521	459.527203
198.5062876	435.0028503
223.0279904	454.5621084
205.5012136	480.0896327
232.0140081	482.5129665
221.514685	466.0627634
215.5011574	452.0469149
197.0126385	426.5146365
200.1062212	445.6373648
195.00643	471.01544
239.0083681	488.0163935
199.5062376	446.0027878
225.0144439	466.5240687
192.0169959	427.5153201
221.0191529	453.701121
193.0052082	425.5497771
214.0093458	457.0462202
220.5056612	476.0052433
206.0012195	478.0636682
208.5095926	499.5424856
203.502457	447.0341432
210.5011849	451.598443
219.0045454	488.0459527
209.0047846	467.6372476
227.5220057	476.5210033
202.5012315	445.5044894
218.5388557	487.0763237
222.5460854	474.0771251
201.5111934	468.5091317
198.6873983	403.5
192.5051812	432.5378662
202.0061698	445.5229905
206.5605242	435.0114626
209.0047846	450.1210899
203.009853	456.0452423
221.5056509	475.0656517
189.5329543	388.1558976
208.5047618	471.009554
212.0235832	450.5473081
227.0550605	451.5376128
200.516163	444.0384383
222.5145937	467.034795
190.0065582	465.0278879
219.0365297	457.5444036
209.029902	446.0477123
222.0956996	438.1925268
216.0857597	457.7359526
201.031136	426.5023202
207.0350197	451.5050223
216.0011628	500.0340581
198.0769367	404.5161609
226.5022076	488.0347711
217.0011521	472.0089374
212.5234946	460.5746777
206.0218456	448.5471379
192.0259586	463.5733852
206.0097085	432.6277703
180.0999753	406.5159354
194.5127743	447.0729099
223.5055853	479.0416991
189.6317803	354.0450721
209.505958	466.0584702
211.0059411	461.0344802
217.0023041	469.0325404
207	469.5363087
195.0320485	460.8913071
190.5221538	459.659866
208.5012019	462.5862499
211.5011793	460.5282175
229.5021789	477.5617451
216.5207843	435.582568
230.0662945	461.0010846
237.0527367	488.034897
222.5202239	466.5567695
227.5	480.093505
215.5475828	468.5198433
204.009804	430.5940696
214.5115899	472.006853
213.0011628	448.502767
206.5496045	477.1765757
215.0117595	456.0666202
214.537293	453.5407773
208.5012019	463.0199776
218.5022884	457.5049778
227.5197795	479.0855482
210.5403305	454.6140631
236.589806	462.5140118
204.0747408	473.5095039
211.0094787	413.0157029
251.0248717	488.5621157
195.5128133	414.1338849
203.5122603	464.0279704
225.567539	459.1663923
204.002451	446.1223268
210.0011849	465.0327945
198.1426245	390.054863
210.0298	443.0559214
231.0021647	448.7696315
199.0213547	459.1049706
210.0154476	444.038134
203.0552461	430.2011116
239.5041666	473.5131802
186.0067871	411.0317193
214.5046948	465.6311338
210.1188555	453.0054239
222.0281164	470.0855316
237.5021053	467.5396401
190.0171395	413.0396217
207.0024154	468.0624442
202.0308959	438.5826944
197	407.5079792
192.0026045	414.5445438
204.5207359	427.029273
207.0012136	441.5190659
205.5012019	450.5269808
201.7242769	438.0568987
242.0537984	496.5371994
201.0559596	421.2592606
197.5063195	450.5089484
216.5011628	443.514671
216.5023096	489.5
204	424.601747
216.6131351	449.5628915
206.015776	452.5410179
nan	475.5805043
225.5143997	458.5616372
216.5092378	467.1479987
191.053657	403.5006204
209.0059637	454.5222176
217.5149288	443.2566852
213.5093676	463.0005411
217.5149552	468.1747857
nan	466.5133935
196.0126517	422.5645525
205.5121886	453.514289
210.5023753	451.0188663
221.5292808	457.0558441
218.0849721	462.0084209
nan	468.5133207
202.5098764	449.524977
215.5754786	466.062661
222.0022523	443.5162544
212.0023586	483.026851
192.0013089	420.5630539
197.506282	454.0396528
223.5056003	434.5051605
214.5477558	455.0994396
210.6009626	483.0067078
199.506275	448.5027779
214.0046728	471.0614707
233.5107617	498.606029
216.5057191	nan
nan	444.054695
225.5022173	454.090172
201.0062004	438.0644373
215.5	467.1960004
208.006027	448.6230664
219.0285368	471.583093
213.0058685	442.5951373
230.5660759	466.0991081
200.0624965	458.0223189
213.1325871	448.1529468
205.5630751	434.0143016
235.0095741	499.0650318
210.0237403	443.100627
202.0247504	468.0651621
221.5382502	473.5894164
217.0207363	406.6999896
236.6194537	486.5375981
211.0011849	438.5028487
201.516113	435.1255834
198.5427651	445.5479385
213.599544	465.1681693
206.5120826	433.6549674
218.207469	429.3888149
206.5206234	408.5797765
202.0508511	432.1859108
219.5057183	480.1004052
201.00995	444.0953513
203.0012315	440.5845869
227.5087911	467.5096259
216.5011521	437.6735656
210	457.5135866
208.510765	441.0387008
199.0402011	422.0506768
217.0023042	462.5092332
216.5302127	462.5269417
204.5121533	419.0870992
238.508386	485.0314541
229.570871	462.048613
195.5666832	418.779335
197.5566948	452.0005543
214.0398033	479.0262526
206.0024272	427.5338889
210.0300438	433.5233049
200.531106	463.515605
194.5784267	393.5331509
223.0145989	484.6428452
214.0047169	455.5535913
194.0025774	416.5678325
218.0057498	459.5185653
216.1133962	447.5359522
206.5157826	426.1910083
221.0022625	447.5139533
224.5111156	465.0735257
199	460.5173726
221.0056715	456.5357768
221.0226229	468.5196835
227.5392946	482.5233884
203.0049504	450.5353955
228.5043478	473.5390824
216.0150457	453.5275626
188.0239374	376.016666
208.0012019	450.0228234
230.5217762	464.5043058
216.2555278	437.8446395
214.502331	464.5085836
205.5889409	458.6393912
200.01	440.5011351
189.5013298	410.53541
193.0584608	414.5078299
186.560212	402.0330979
215.5011574	470.0533836
213	481.0087397
190.5445583	441.5724766
218.6121	424.5011779
190.0013228	426.0099352
207.5493656	466.0429158
208.5407168	455.6140958
219.5056716	469.0155303
206.5217908	448.5055991
222.5225008	463.509709
218.0470131	497.5412432
188.5066418	459.1055635
218.0057339	nan
181.5055554	445.0112973
201.0099503	440.0284084
199.1255854	456.540597
216.5057656	463.6078655
212.0058962	459.5097937
215.0023258	464.0312485
208.0060095	441.5096745
191.0444963	412.0303389
195.5128133	425.5148451
197.0063451	426.0897719
199.0314493	463.0960943
206.6073779	437.6287608
217.5057391	495.0247463
216.0474483	479.3015098
236.5527358	517.006291
220.5566823	432.7265378
200.1703151	436.0486868
210.0119042	471.5089551
206.5436801	446.0650152
213.0481164	459.6225163
204.510975	444.5072838
207.015671	455.1260579
206.506062	452.5226459
203.5061699	442.1368127
203.5061515	452.5980315
214.5058522	430.6853902
241.0010417	478.0252045
191.006504	447.0557478
227.5549387	475.5136562
211.0614903	446.219678
217.5517874	460.5918047];
end;

% Constants
[n,~] = size(x);

%% Sampling
% MCMC Parameters
nchains = 2; % How Many Chains?
nburnin = 5e3; % How Many Burn-in Samples?
nsamples = 5e3;  %How Many Recorded Samples?
nthin = 1; % How Often is a Sample Recorded?
doparallel = 0; % Parallel Option

% Assign Matlab Variables to the Observed Nodes
datastruct = struct('x',x,'n',n);

% Initial Values to Supply to WinBugs
for i=1:nchains
    S.r = 0;
    S.mu = zeros(1,2);
    S.lambda = ones(1,2);
    init0(i) = S;
end

if ~sampler
    % Use WinBUGS to Sample
    tic
[samples, stats] = matbugs(datastruct, ...
    fullfile(pwd, 'Correlation_1.txt'), ...
    'init', init0, ...
    'nChains', nchains, ...
    'view', 1, 'nburnin', nburnin, 'nsamples', nsamples, ...
    'thin', nthin, 'DICstatus', 0, 'refreshrate',100, ...
    'monitorParams', {'r','mu','sigma'}, ...
    'Bugdir', 'C:/Program Files/WinBUGS14');
else
    % Use JAGS to Sample
    tic
    fprintf( 'Running JAGS ...\n' );
    [samples, stats] = matjags( ...
        datastruct, ...
        fullfile(pwd, 'Correlation_1.txt'), ...
        init0, ...
        'doparallel' , doparallel, ...
        'nchains', nchains,...
        'nburnin', nburnin,...
        'nsamples', nsamples, ...
        'thin', nthin, ...
        'monitorparams', {'r','mu','sigma'}, ...
        'savejagsoutput' , 1 , ...
        'verbosity' , 1 , ...
        'cleanup' , 0 , ...
        'workingdir' , 'tmpjags' );
    toc
end;

%% Ananlysis
figure(10+dataset);clf;hold on;
set(gcf,'units','norm','pos',[.2 .2 .6 .4],'paperpositionmode','auto');
eps = .02; binsc = -1+eps/2:eps:1-eps/2; binse = -1:eps:1;
subplot(121);hold on;
ph = plot(x(:,1),x(:,2),'ko');
set(ph,'markersize',4,'markerfacecolor','k');
axis([0 1.5 85 115]);
set(gca,'box','on','fontsize',14,'xtick',0:.25:1.5,'ytick',85:5:115);
xlabel('Response Time (sec)','fontsize',16);
ylabel('IQ','fontsize',16);
subplot(122);hold on;
count = histc(reshape(samples.r,1,[]),binse);
count = count(1:end-1);
count = count/sum(count)/eps;
ph = plot(binsc,count,'k-');
set(gca,'box','on','fontsize',14,'xtick',[-1:.5:1],'ytick',[]);
tmp = corrcoef(x);
ph = plot(ones(1,2)*tmp(1,2),[0 max(get(gca,'ylim'))],'k--');
xlabel('Correlation','fontsize',16);
ylabel('Posterior Density','fontsize',16);



